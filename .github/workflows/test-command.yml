name: Run Integration Test
on:
  workflow_dispatch:
    inputs:
      connector:
        description: "Airbyte Connector"
        required: true
      repo:
        description: "Repo to check out code from. Defaults to the main airbyte repo. Set this when building connectors from forked repos."
        required: false
        default: "airbytehq/airbyte"
      gitref:
        description: "The git ref to check out from the specified repository."
        required: false
        default: master
      comment-id:
        description: "The comment-id of the slash command. Used to update the comment with the status."
        required: false
      uuid:
        description: "Custom UUID of workflow run. Used because GitHub dispatches endpoint does not return workflow run id."
        required: false

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.gitref }}
      - name: Mock connection publication
        id: test
        run: |
          echo "Mock connection test (sleep for 12 seconds)..."
          sleep 12
          echo "Integration test for connector ${{ github.event.inputs.connector }} has completed"
      - name: Mark workflow as completed
        run: |
          echo "{ \"${{ github.event.inputs.connector }}\": \"${{ steps.test.outcome }}\" }" > connector_test.json
      - name: Run Stoat action
        uses: stoat-dev/stoat-action@liren/airbyte-connector-plugin
        if: always()
